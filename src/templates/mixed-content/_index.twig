{% extends '_layouts/cp' %}
{% import '_includes/forms' as forms %}

{% set title = "Mixed Content Check"|t('upsnap') %}
{% do view.registerAssetBundle("appfoster\\upsnap\\assetbundles\\monitor\\MixedContentAsset") %}

{% block actionButton %}
	<div class="buttons">
		<div class="btngroup">
			<button type="button" class="btn submit" data-icon="refresh" id="refresh-btn">
				{{ 'Refresh'|t('upsnap') }}
			</button>
		</div>
	</div>
{% endblock %}

{% block content %}

	{% set hasMixed = data.details.mixedCount is defined and data.details.mixedCount > 0 %}

	{% set statusClass = data.status == 'ok' and not hasMixed ? 'success' : (data.status == 'error' ? 'error' : (hasMixed ? 'warning' : 'warning')) %}
	{% set containerClass = data.status == 'ok' and not hasMixed ? '' : (data.status == 'error' ? 'error' : (hasMixed ? 'warning' : 'warning')) %}

	<div class="status-container {{ containerClass }}">
		<div class="status-header">
			<div class="status-icon {{ statusClass }}">
				{% if data.status == 'ok' and not hasMixed %}
					✓
				{% elseif data.status == 'error' %}
					✗
				{% elseif hasMixed %}
					!
				{% else %}
					!
				{% endif %}
			</div>
			<h3 class="status-title">
				{% if data.status == 'ok' and not hasMixed %}
					{{ 'No mixed content found!'|t('upsnap') }}
				{% elseif data.status == 'error' %}
					{{ 'Mixed content check failed!'|t('upsnap') }}
				{% elseif hasMixed %}
					{{ 'Mixed content detected!'|t('upsnap') }}
				{% else %}
					{{ 'Mixed content check has some warnings!'|t('upsnap') }}
				{% endif %}
			</h3>
		</div>

		{% if data.details.mixedCount is defined %}
			<p class="status-message">
				{% if data.details.mixedCount == 0 %}
					{{ 'Great! No mixed content was found on your site.'|t('upsnap') }}
				{% else %}
					{{ '{count} mixed content items were found on your site.'|t('upsnap', { count: data.details.mixedCount }) }}
				{% endif %}
			</p>
		{% endif %}

		{% if data.error is defined %}
			<ul class="error-list">
				{% if data.error is iterable %}
					{% for err in data.error %}
						<li>{{ err }}</li>
					{% endfor %}
				{% else %}
					<li>{{ data.error }}</li>
				{% endif %}
			</ul>
		{% endif %}
	</div>


	<div class="pane">
		<div class="meta read-only">
			<div class="data fullwidth">
				<div class="field">
					<div class="heading">{{ "Monitored URL"|t('upsnap') }}</div>
					<div>
						<a href="{{ data.url }}" target="_blank">{{ data.url }}</a>
					</div>
				</div>

				<div class="field">
					<div class="heading">{{ "Last Checked"|t('upsnap') }}</div>
					<div>{{ data.checkedAt|date("d M Y, H:i:s") }}</div>
				</div>

				<div class="field">
					<div class="heading">{{ "Response Time"|t('upsnap') }}</div>
					<div>{{ data.duration ?? '–' }}</div>
				</div>
			</div>
			{% if data.details.mixedContentItems is defined and data.details.mixedContentItems|length > 0 %}
				<div class="data fullwidth">
					<div class="field">
							<div class="heading">{{ "Mixed Contents"|t('upsnap') }}</div>
							<ul class="error-list margin-top">
								{% for url in data.details.mixedContentItems %}
									<li>
										<a href={{ url }}>{{ url }}</a>
									</li>
								{% endfor %}
							</ul>
						</div>
					</div>
				</div>
			{% endif %}
		</div>
	{% endblock %}
