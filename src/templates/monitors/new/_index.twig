{% extends "_layouts/cp" %}
{% import "_includes/forms" as forms %}

{% set monitor = monitor ?? null %}
{% set mode = mode ?? 'add' %}

{% block content %}

	<form method="post" accept-charset="UTF-8">
		{{ csrfInput() }}

		{% if mode == 'edit' %}
			{{ hiddenInput('monitorId', monitor ? monitor.id : null) }}
		{% endif %}

		<h2>{{ mode == 'add' ? "Add Monitor" : "Edit Monitor" }}</h2>

		<div class="flex">
			<div class="flex-grow" style="margin-right: 20px;">
				{{ forms.textField({
                label: "Monitor Name",
                id: "name",
                name: "name",
                value: monitor ? monitor.name : "",
                required: true,
                errors: []
            }) }}
			</div>

			<div class="flex-grow">
				{{ forms.textField({
                label: "URL",
                id: "url",
                name: "url",
                placeholder: "https://example.com",
                value: monitor ? monitor.url : "",
                required: true,
                errors: []
            }) }}
			</div>
		</div>

		<div id="notification-channels-accordion" class="field">
			<div class="heading">
				<button type="button" id="integrations-trigger" class="accordion-trigger" aria-expanded="false" aria-controls="notification-channels-content">
					<span class="accordion-arrow"></span>
					<span>How would you like to get notified?</span>
				</button>
			</div>

			<div id="notification-channels-content" class="accordion-content hidden">
				<div class="spinner hidden" id="channels-loading-spinner"></div>

				<table class="data fullwidth" id="channels-table" style="display:none;">
					<thead>
						<tr>
							<th class="thin"><input type="checkbox" id="select-all-channels"></th>
							<th>Name</th>
							<th>Channel Type</th>
						</tr>
					</thead>
					<tbody id="channels-tbody"></tbody>
				</table>
			</div>
		</div>


		<div id="advanced-settings-accordion" class="field">
			<div class="heading">
				<button type="button" id="settings-accordion" class="accordion-trigger" aria-expanded="false" aria-controls="notification-channels-content">
					<span class="accordion-arrow"></span>
					<span>Advanced Settings</span>
				</button>
			</div>

			<div id="advanced-settings-content" class="accordion-content hidden">
				{{ forms.lightswitchField({
                    label: "Enable Monitoring",
                    id: "enabled",
                    name: "enabled",
                    on: monitor ? (monitor.enabled ?? true) : true
                }) }}

				<h3 class="heading">Healthcheck Settings</h3>

				<div id="advanced-settings" style="{% if not (monitor ? (monitor.enabled ?? false) : false) %}display:none;{% endif %}">
					<hr>

					{# ------------ ROW 1 ------------ #}
					<div class="healthcheck-row-grid">
						<div class="healthcheck-section">
							{{ forms.lightswitchField({
                                label: "Broken Links Check"|t('upsnap'),
                                instructions: "Monitor for broken links on your site"|t('upsnap'),
                                id: 'brokenLinksEnabled',
                                name: 'brokenLinksEnabled',
                                on: monitor ? (monitor.brokenLinksEnabled ?? true) : true,
                            }) }}

							<div class="nested-settings-inline" id="brokenLinks-settings">
								{{ forms.selectField({
                                    label: "Monitoring Interval"|t('upsnap'),
                                    id: 'brokenLinksMonitoringInterval',
                                    name: 'brokenLinksMonitoringInterval',
                                    options: intervalOptions,
                                    value: monitor ? (monitor.brokenLinksMonitoringInterval ?? "1m") : "1m",
                                }) }}
							</div>
						</div>

						<div class="healthcheck-section">
							{{ forms.lightswitchField({
                                label: "Mixed Content Check"|t('upsnap'),
                                instructions: "Monitor for mixed content issues"|t('upsnap'),
                                id: 'mixedContentEnabled',
                                name: 'mixedContentEnabled',
                                on: monitor ? (monitor.mixedContentEnabled ?? true) : true,
                            }) }}

							<div class="nested-settings-inline" id="mixedContent-settings" {% if not (monitor ? (monitor.mixedContentEnabled ?? true) : true) %} style="display:none;" {% endif %}>
								{{ forms.selectField({
                                    label: "Monitoring Interval"|t('upsnap'),
                                    id: 'mixedContentMonitoringInterval',
                                    name: 'mixedContentMonitoringInterval',
                                    options: intervalOptions,
                                    value: monitor ? (monitor.mixedContentMonitoringInterval ?? "1m") : "1m",
                                }) }}
							</div>
						</div>
					</div>

					{# ------------ ROW 2 ------------ #}
					<div class="healthcheck-row-grid">
						<div class="healthcheck-section">
							{{ forms.lightswitchField({
                                label: "Lighthouse Performance Check"|t('upsnap'),
                                instructions: "Monitor site performance"|t('upsnap'),
                                id: 'lighthouseEnabled',
                                name: 'lighthouseEnabled',
                                on: monitor ? (monitor.lighthouseEnabled ?? false) : true,
                            }) }}

							<div class="nested-settings-inline" id="lighthouse-settings">
								{{ forms.selectField({
                                    label: "Monitoring Interval"|t('upsnap'),
                                    id: 'lighthouseMonitoringInterval',
                                    name: 'lighthouseMonitoringInterval',
                                    options: intervalOptions,
                                    value: monitor ? (monitor.lighthouseMonitoringInterval ?? "1m") : "1m",
                                }) }}

								{{ forms.selectField({
                                    label: "Strategy Type"|t('upsnap'),
                                    id: 'lighthouseStrategy',
                                    name: 'lighthouseStrategy',
                                    options: strategyOptions,
                                    value: monitor ? (monitor.lighthouseStrategy ?? 'desktop') : 'desktop',
                                }) }}
							</div>
						</div>

						<div class="healthcheck-section">
							{{ forms.lightswitchField({
                                label: "Reachability Check"|t('upsnap'),
                                instructions: "Monitor if the site is reachable"|t('upsnap'),
                                id: 'reachabilityEnabled',
                                name: 'reachabilityEnabled',
                                on: monitor ? (monitor.reachabilityEnabled ?? true) : true,
                            }) }}

							<div class="nested-settings-inline" id="reachability-settings">
								{{ forms.selectField({
                                    label: "Monitoring Interval"|t('upsnap'),
                                    id: 'reachabilityMonitoringInterval',
                                    name: 'reachabilityMonitoringInterval',
                                    options: intervalOptions,
                                    value: monitor ? (monitor.reachabilityMonitoringInterval ?? "1m") : "1m",
                                }) }}
							</div>
						</div>
					</div>

					{# ------------ ROW 3 ------------ #}
					<div class="healthcheck-row-grid">
						<div class="healthcheck-section">
							{{ forms.lightswitchField({
                                label: "SSL Certificate Check"|t('upsnap'),
                                id: 'sslEnabled',
                                name: 'sslEnabled',
                                on: monitor ? (monitor.securityCertificatesEnabled ?? true) : true,
                            }) }}

							<div class="nested-settings-inline" id="ssl-settings">
								{{ forms.selectField({
                                    label: "Days Before Expiry"|t('upsnap'),
                                    id: 'sslExpiryDays',
                                    name: 'sslDaysBeforeExpiryAlert',
                                    options: expiryDayOptions,
                                    value: monitor ? (monitor.sslDaysBeforeExpiryAlert ?? "30") : "30"
                                }) }}

								{{ forms.selectField({
                                    label: "Monitoring Interval"|t('upsnap'),
                                    id: 'securityCertificatesMonitoringInterval',
                                    name: 'securityCertificatesMonitoringInterval',
                                    options: intervalOptions,
                                    value: monitor ? (monitor.securityCertificatesMonitoringInterval ?? "1m") : "1m",
                                }) }}
							</div>
						</div>

						<div class="healthcheck-section">
							{{ forms.lightswitchField({
                                label: "Domain Expiry Check"|t('upsnap'),
                                id: 'domainEnabled',
                                name: 'domainEnabled',
                                on: monitor ? (monitor.domainEnabled ?? true) : true,
                            }) }}

							<div class="nested-settings-inline" id="domain-settings">
								{{ forms.selectField({
                                    label: "Days Before Expiry"|t('upsnap'),
                                    id: 'domainExpiryDays',
                                    name: 'domainDaysBeforeExpiryAlert',
                                    options: expiryDayOptions,
                                    value: monitor ? (monitor.domainDaysBeforeExpiryAlert ?? "30") : "30"
                                }) }}

								{{ forms.selectField({
                                    label: "Monitoring Interval"|t('upsnap'),
                                    id: 'domainMonitoringInterval',
                                    name: 'domainMonitoringInterval',
                                    options: intervalOptions,
                                    value: monitor ? (monitor.domainMonitoringInterval ?? "1m") : "1m",
                                }) }}
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</form>
	<button class="btn submit " id="save-monitor">{{ mode == 'add' ? "Create Monitor" : "Save Changes" }}</button>
    
    <script>
        window.preSelectedChannelIds = {{ monitor ? monitor.channelIds|json_encode|raw : '[]' }};
    </script>
{% endblock %}

