{% extends '_layouts/cp' %}
{% import '_includes/forms' as forms %}

{% set title = "Uptime Monitoring"|t('upsnap') %}
{% do view.registerAssetBundle("appfoster\\upsnap\\assetbundles\\upsnap\\ReachabilityAsset") %}

{% set tabs = {
    status: { label: 'Current Status', url: url('upsnap/reachability') },
    history: { label: 'History', url: url('upsnap/reachability/history') }
} %}

{% set selectedTab = 'history' %}

{% block actionButton %}
	<div class="buttons">
		<div class="btngroup">
			<button type="button" class="btn submit" data-icon="refresh" onclick="window.location.reload();">
				{{ 'Refresh'|t('upsnap') }}
			</button>
		</div>
	</div>
{% endblock %}

{% block content %}
	<!-- Summary Statistics -->
	{% if stats.total > 0 %}
		<div class="stats-container">
			<div class="stats-grid">
				<div class="stat-card">
					<div class="stat-number">{{ stats.uptimePercentage }}%</div>
					<div class="stat-label">{{ 'Uptime'|t('upsnap') }}</div>
				</div>
				<div class="stat-card">
					<div class="stat-number">{{ stats.total }}</div>
					<div class="stat-label">{{ 'Total Checks'|t('upsnap') }}</div>
				</div>
				<div class="stat-card success">
					<div class="stat-number">{{ stats.succeeded }}</div>
					<div class="stat-label">{{ 'Succeeded'|t('upsnap') }}</div>
				</div>
				<div class="stat-card warning">
					<div class="stat-number">{{ stats.warning }}</div>
					<div class="stat-label">{{ 'Warnings'|t('upsnap') }}</div>
				</div>
				<div class="stat-card error">
					<div class="stat-number">{{ stats.failed }}</div>
					<div class="stat-label">{{ 'Failed'|t('upsnap') }}</div>
				</div>
			</div>
		</div>
	{% endif %}

	<!-- Filters Form -->
	<div class="filters-container">
		<form method="get" action="{{ url('upsnap/reachability/history') }}" class="filters-form">
			<div class="filters-grid">
				<div class="filter-group">
					{{ forms.dateField({
                        label: 'Start Date'|t('upsnap'),
                        name: 'startDate',
                        value: filters.startDate,
                        class: 'filter-input'
                    }) }}
				</div>

				<div class="filter-group">
					{{ forms.dateField({
                        label: 'End Date'|t('upsnap'),
                        name: 'endDate',
                        value: filters.endDate,
                        class: 'filter-input'
                    }) }}
				</div>

				<div class="filter-group">
					{{ forms.selectField({
                        label: 'Status'|t('upsnap'),
                        name: 'status',
                        value: filters.status,
                        options: {
                            'all': 'All'|t('upsnap'),
                            'succeeded': 'Succeeded'|t('upsnap'),
                            'failed': 'Failed'|t('upsnap'),
                            'warning': 'Warning'|t('upsnap')
                        },
                        class: 'filter-input'
                    }) }}
				</div>

				<div class="filter-group">
					{{ forms.selectField({
                        label: 'Type'|t('upsnap'),
                        name: 'type',
                        value: filters.type,
                        options: {
                            'all': 'All'|t('upsnap'),
                            'uptime': 'Uptime'|t('upsnap'),
                            'performance': 'Performance'|t('upsnap'),
                            'ssl': 'SSL'|t('upsnap')
                        },
                        class: 'filter-input'
                    }) }}
				</div>

				<div class="filter-actions">
					<button type="submit" class="btn submit">
						{{ 'Filter'|t('upsnap') }}
					</button>
					<a href="{{ url('upsnap/reachability/history') }}" class="btn">
						{{ 'Reset'|t('upsnap') }}
					</a>
				</div>
			</div>
		</form>
	</div>

	<!-- History Results -->
	<div class="history-container">
		{% if history|length > 0 %}
			<div class="history-header">
				<h3>{{ 'Check History'|t('upsnap') }}</h3>
				<span class="result-count">
					{{ 'Showing {count} results'|t('upsnap', { count: history|length }) }}
				</span>
			</div>

			<div class="history-table-container">
				<table class="history-table">
					<thead>
						<tr>
							<th>{{ 'Type'|t('upsnap') }}</th>
							<th>{{ 'Result'|t('upsnap') }}</th>
							<th>{{ 'Timestamp'|t('upsnap') }}</th>
							<th>{{ 'Duration'|t('upsnap') }}</th>
							<th>{{ 'Details'|t('upsnap') }}</th>
						</tr>
					</thead>
					<tbody>
						{% for record in history %}
							<tr class="history-row" onclick="toggleDetails({{ record.id }})">
								<td>
									<div class="type-info">
										<strong>{{ record.type }}</strong>
										<div class="site-url">{{ record.site }}</div>
									</div>
								</td>
								<td>
									<span class="status-badge status-{{ record.status }}">
										{% if record.status == 'succeeded' %}
											{{ 'Succeeded'|t('upsnap') }}
										{% elseif record.status == 'failed' %}
											{{ 'Failed'|t('upsnap') }}
										{% elseif record.status == 'warning' %}
											{{ 'Warning'|t('upsnap') }}
										{% else %}
											{{ record.status|title }}
										{% endif %}
									</span>
								</td>
								<td>
									<div class="timestamp">
										{{ record.timestamp|date('M d, Y') }}
										<div class="time">{{ record.timestamp|date('H:i:s') }}</div>
									</div>
								</td>
								<td>{{ record.duration }}</td>
								<td>
									<button class="details-toggle" type="button">
										{{ 'View Details'|t('upsnap') }}
										<span class="toggle-icon">â–¼</span>
									</button>
								</td>
							</tr>
							<tr class="details-row" id="details-{{ record.id }}" style="display: none;">
								<td colspan="5">
									<div class="details-content">
										<div class="details-grid">
											<div class="detail-item">
												<strong>{{ 'HTTP Status'|t('upsnap') }}:</strong>
												{% if record.httpCode %}
													<span class="http-status-code {{ record.httpCode >= 400 ? 'error' : 'success' }}">
														{{ record.httpCode }}
													</span>
												{% else %}
													<span class="text-gray">{{ 'N/A'|t('upsnap') }}</span>
												{% endif %}
											</div>

											{% if record.responseTime %}
												<div class="detail-item">
													<strong>{{ 'Response Time'|t('upsnap') }}:</strong>
													<span>{{ record.responseTime }}ms</span>
												</div>
											{% endif %}

											<div class="detail-item">
												<strong>{{ 'Location'|t('upsnap') }}:</strong>
												<span>{{ record.location }}</span>
											</div>

											<div class="detail-item">
												<strong>{{ 'IP Address'|t('upsnap') }}:</strong>
												<span>{{ record.ip }}</span>
											</div>

											{# {% if record.details.contentLength %}
												<div class="detail-item">
													<strong>{{ 'Content Length'|t('upsnap') }}:</strong>
													<span>{{ (record.details.contentLength / 1024)|round(1) }}
														KB</span>
												</div>
											{% endif %} #}

											{% if record.details.sslValid is defined %}
												<div class="detail-item">
													<strong>{{ 'SSL Status'|t('upsnap') }}:</strong>
													<span class="{{ record.details.sslValid ? 'success' : 'error' }}">
														{{ record.details.sslValid ? 'Valid'|t('upsnap') : 'Invalid'|t('upsnap') }}
													</span>
												</div>
											{% endif %}
										</div>

										{% if record.details.message %}
											<div class="detail-message">
												<strong>{{ 'Message'|t('upsnap') }}:</strong>
												<p>{{ record.details.message }}</p>
											</div>
										{% endif %}
{# 
										{% if record.details.error %}
											<div class="detail-error">
												<strong>{{ 'Error'|t('upsnap') }}:</strong>
												<p class="error-text">{{ record.details.error }}</p>
											</div>
										{% endif %} #}

										{# {% if record.details.warning %}
											<div class="detail-warning">
												<strong>{{ 'Warning'|t('upsnap') }}:</strong>
												<p class="warning-text">{{ record.details.warning }}</p>
											</div>
										{% endif %} #}
									</div>
								</td>
							</tr>
						{% endfor %}
					</tbody>
				</table>
			</div>
		{% else %}
			<div class="no-results">
				<div class="no-results-icon">ðŸ“Š</div>
				<h3>{{ 'No history found'|t('upsnap') }}</h3>
				<p>{{ 'Try adjusting your filters or check back later for monitoring data.'|t('upsnap') }}</p>
			</div>
		{% endif %}
	</div>

{% endblock %}
