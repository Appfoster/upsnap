{% extends "_layouts/cp" %}
{% import "_includes/forms" as forms %}

{% set showHealthchecks = showHealthchecks ?? false %}
{% set isActiveApiToken = apiTokenStatus is same as(apiTokenStatuses.active) ? true : false %}

{% set tabs = [
	{ label: "General"|t('upsnap'), url: '#general-tab', class: 'sel' }
] %}

{% if showHealthchecks and (settings.monitorId ?? false) %}
	{% set tabs = tabs|merge([
		isActiveApiToken
			? { label: "Healthchecks"|t('upsnap'), url: '#healthchecks-tab' }
			: { label: "Healthchecks"|t('upsnap'), url: '#healthchecks-tab', class: 'disabled-tab' },
		isActiveApiToken
			? { label: "Notification Channels"|t('upsnap'), url: '#notification-channels-tab' }
			: { label: "Notification Channels"|t('upsnap'), url: '#notification-channels-tab', class: 'disabled-tab' }
	]) %}
{% endif %}


{% block actionButton %}
	 <div class="flex smallgap">
		<button
			type="button"
			class="btn add icon{% if not isActiveApiToken %} disabled{% endif %}"
			id="add-monitor-btn"
			{% if not isActiveApiToken %}disabled aria-disabled="true"{% endif %}
		>
			{{ "Add Monitor"|t('upsnap') }}
		</button>
		<button id="save-button" type="submit" form="settings-form" class="btn submit">
			{{ "Save"|t('upsnap') }}
		</button>        
    </div>
{% endblock %}
{% set apiTokenStatus = apiTokenStatus ?? 'expired' %}

{% set statusColorMap = {
    (apiTokenStatuses['active']): 'pill--green',
    (apiTokenStatuses['expired']): 'pill--red',
    (apiTokenStatuses['deleted']): 'pill--grey',
    (apiTokenStatuses['suspended']): 'pill--yellow'
} %}

{% set statusColorClass = statusColorMap[apiTokenStatus]|default('pill--grey') %}


{% block content %}
	{# Include modal component separately #}
	{% include "upsnap/_components/addMonitorModal.twig" %}

	{# inject server values for JS to consume - put this before monitor.js is loaded #}
	<script>
		window.Upsnap = window.Upsnap || {};
		window.Upsnap.settings = {
			monitoringUrl: {{ (settings.monitoringUrl ?? '')|json_encode|raw }},
			apiKey: {{ (showHealthchecks ?? '')|json_encode|raw }},
			isActiveApiToken : {{ (isActiveApiToken ?? '')|json_encode|raw }}
		};
	</script>
	<form id="settings-form" method="post" accept-charset="UTF-8" enctype="multipart/form-data">
		{{ csrfInput() }}
		{{ actionInput('upsnap/settings/save', { id: 'form-action-input' }) }}
		{{ redirectInput('upsnap/settings') }}

		{# ====================== GENERAL TAB ====================== #}
		<div id="general-tab" class="tab-content">

			{{ forms.selectField({
				label: "Select Monitor"|t('upsnap'),
				instructions: "Choose a monitor from the available list or create a new one."|t('upsnap'),
				id: "monitorDropdown",
				name: "monitoringUrl",
				options: [
					{ label: "Loading monitors...", value: "" }
				],
				value: settings.monitoringUrl ?? "",
				data: { value: settings.monitoringUrl ?? "" }, 
				errors: settings.getErrors("monitoringUrl") ?? false
			}) }}

			<input type="hidden" id="monitorId" name="monitorId" value="{{ settings.monitorId ?? '' }}">

			<div class="api-key-field-with-status">
				{{ forms.textField({
                    label: "API Key"|t('upsnap'),
                    instructions: "Enter the Upsnap API Key and save to enable Healthcheck settings. To access the API key, please visit the Upsnap dashboard at <a href='#{upsnapDashboardUrl}' target='_blank' rel='noopener noreferrer'>Upsnap Dashboard<span class='sr-only' style='position:absolute;left:-10000px;'> (opens in a new tab)</span></a>"|t('upsnap')|raw,
                    id: 'apiKey',
                    name: 'apiKey',
                    type: 'text',
                    value: settings.apiKey ?? '',
                    placeholder: 'XXXX-XXXX-XXXX-XXXX',
                    errors: settings.getErrors('apiKey') ?? false
                }) }}
				{% if showHealthchecks %}
					<span class="api-pill {{ statusColorClass }}">
						{{ apiTokenStatus|capitalize }}
					</span>
				{% endif %}
			</div>

		</div>

		{# ====================== HEALTHCHECK TAB ====================== #}
		{# TODO	 just show the disabled tab and not the content here #}
		{% if showHealthchecks and isActiveApiToken %} 
			<div id="healthchecks-tab" class="tab-content hidden">
				{{ forms.lightswitchField({
					label: "Enable Monitoring"|t('upsnap'),
					instructions: "Turn monitoring on or off"|t('upsnap'),
					id: 'enabled',
					name: 'enabled',
					on: settings.enabled ?? false,
					errors: settings.getErrors('enabled') ?? false
				}) }}

				<div id="advanced-settings" style="{% if not (settings.enabled ?? false) %}display:none;{% endif %}">
					<hr>

					<h2>{{ "Healthcheck Endpoints"|t('upsnap') }}</h2>
					<p class="light ">{{ "Configure monitoring settings for each healthcheck endpoint"|t('upsnap') }}</p>

					{# First Row: Broken Links and Mixed Content #}
					<div class="healthcheck-row-grid">
						<div class="healthcheck-section">
							{{ forms.lightswitchField({
								label: "Broken Links Check"|t('upsnap'),
								instructions: "Monitor for broken links on your site"|t('upsnap'),
								id: 'brokenLinksEnabled',
								name: 'brokenLinksEnabled',
								on: settings.brokenLinksEnabled ?? true,
								errors: settings.getErrors('brokenLinksEnabled') ?? false
							}) }}
							<div class="nested-settings-inline" id="brokenLinks-settings">
								{{ forms.selectField({
									label: "Monitoring Interval"|t('upsnap'),
									id: 'brokenLinksMonitoringInterval',
									name: 'brokenLinksMonitoringInterval',
									options: intervalOptions,
									value: settings.brokenLinksMonitoringInterval ?? "1m",
									errors: settings.getErrors('brokenLinksMonitoringInterval') ?? false
								}) }}
							</div>
						</div>

						<div class="healthcheck-section">
							{{ forms.lightswitchField({
								label: "Mixed Content Check"|t('upsnap'),
								instructions: "Monitor for mixed content issues (HTTP content on HTTPS pages)"|t('upsnap'),
								id: 'mixedContentEnabled',
								name: 'mixedContentEnabled',
								on: settings.mixedContentEnabled ?? true,
								errors: settings.getErrors('mixedContentEnabled') ?? false
							}) }}
							<div class="nested-settings-inline" id="mixedContent-settings" {% if not (settings.mixedContentEnabled ?? true) %}style="display:none;"{% endif %}>
								{{ forms.selectField({
									label: "Monitoring Interval"|t('upsnap'),
									id: 'mixedContentMonitoringInterval',
									name: 'mixedContentMonitoringInterval',
									options: intervalOptions,
									value: settings.mixedContentMonitoringInterval ?? "1m",
									errors: settings.getErrors('mixedContentMonitoringInterval') ?? false
								}) }}
							</div>
						</div>
					</div>

					{# Second Row: Lighthouse and Reachability #}
					<div class="healthcheck-row-grid">
						<div class="healthcheck-section">
							{{ forms.lightswitchField({
								label: "Lighthouse Performance Check"|t('upsnap'),
								instructions: "Monitor site performance using Google Lighthouse"|t('upsnap'),
								id: 'lighthouseEnabled',
								name: 'lighthouseEnabled',
								on: settings.lighthouseEnabled ?? false,
								errors: settings.getErrors('lighthouseEnabled') ?? false
							}) }}
							<div class="nested-settings-inline" id="lighthouse-settings">
								{{ forms.selectField({
									label: "Monitoring Interval"|t('upsnap'),
									id: 'lighthouseMonitoringInterval',
									name: 'lighthouseMonitoringInterval',
									options: intervalOptions,
									value: settings.lighthouseMonitoringInterval ?? "1m",
									errors: settings.getErrors('lighthouseMonitoringInterval') ?? false
								}) }}
								{{ forms.selectField({
									label: "Strategy Type"|t('upsnap'),
									id: 'lighthouseStrategy',
									name: 'lighthouseStrategy',
									options: strategyOptions,
									value: settings.lighthouseStrategy ?? 'desktop',
									errors: settings.getErrors('lighthouseStrategy') ?? false
								}) }}
							</div>
						</div>

						<div class="healthcheck-section">
							{{ forms.lightswitchField({
								label: "Reachability Check"|t('upsnap'),
								instructions: "Monitor if the site is reachable"|t('upsnap'),
								id: 'reachabilityEnabled',
								name: 'reachabilityEnabled',
								on: settings.reachabilityEnabled ?? true,
								errors: settings.getErrors('reachabilityEnabled') ?? false
							}) }}
							<div class="nested-settings-inline" id="reachability-settings">
								{{ forms.selectField({
									label: "Monitoring Interval"|t('upsnap'),
									id: 'reachabilityMonitoringInterval',
									name: 'reachabilityMonitoringInterval',
									options: [
										{ label: "30 seconds"|t('upsnap'), value: "30s" },
										{ label: "1 minute"|t('upsnap'), value: "1m" },
										{ label: "10 minutes"|t('upsnap'), value: "10m" },
										{ label: "1 hour"|t('upsnap'), value: "1h" }
									],
									value: settings.reachabilityMonitoringInterval ?? "1m",
									errors: settings.getErrors('reachabilityMonitoringInterval') ?? false
								}) }}
							</div>
						</div>
					</div>

					{# Third Row: SSL and Domain #}
					<div class="healthcheck-row-grid">
						<div class="healthcheck-section">
							{{ forms.lightswitchField({
								label: "SSL Certificate Check"|t('upsnap'),
								instructions: "Monitor SSL certificate expiration"|t('upsnap'),
								id: 'sslEnabled',
								name: 'securityCertificatesEnabled',
								on: settings.securityCertificatesEnabled ?? true,
								errors: settings.getErrors('securityCertificatesEnabled') ?? false
							}) }}
							<div class="nested-settings-inline" id="ssl-settings">
								{{ forms.selectField({
									label: "Days Before Expiry"|t('upsnap'),
									id: 'sslExpiryDays',
									name: 'sslDaysBeforeExpiryAlert',
									options: expiryDayOptions,
									value: settings.sslDaysBeforeExpiryAlert ?? "30"
								}) }}
								{{ forms.selectField({
									label: "Monitoring Interval"|t('upsnap'),
									id: 'securityCertificatesMonitoringInterval',
									name: 'securityCertificatesMonitoringInterval',
									options: intervalOptions,
									value: settings.securityCertificatesMonitoringInterval ?? "1m",
									errors: settings.getErrors('securityCertificatesMonitoringInterval') ?? false
								}) }}
							</div>
						</div>

						<div class="healthcheck-section">
							{{ forms.lightswitchField({
								label: "Domain Expiry Check"|t('upsnap'),
								instructions: "Monitor domain expiration"|t('upsnap'),
								id: 'domainEnabled',
								name: 'domainEnabled',
								on: settings.domainEnabled ?? true,
								errors: settings.getErrors('domainEnabled') ?? false
							}) }}
							<div class="nested-settings-inline" id= "domain-settings">
								{{ forms.selectField({
									label: "Days Before Expiry"|t('upsnap'),
									id: 'domainExpiryDays',
									name: 'domainDaysBeforeExpiryAlert',
									options: expiryDayOptions,
									value: settings.domainDaysBeforeExpiryAlert ?? "30"
								}) }}
								{{ forms.selectField({
									label: "Monitoring Interval"|t('upsnap'),
									id: 'domainMonitoringInterval',
									name: 'domainMonitoringInterval',
									options: intervalOptions,
									value: settings.domainMonitoringInterval ?? "1m",
									errors: settings.getErrors('domainMonitoringInterval') ?? false
								}) }}
							</div>
						</div>
					</div>
				</div>
			</div>
		{% endif %}
		{% include "upsnap/_components/notificationChannels.twig" %}
	</form>
	
{% endblock %}

{% block foot %}
    <script>
        window.CraftPageData = {
            title: {{ title|json_encode|raw }},
            monitorUrl: {{ settings.monitoringUrl|json_encode|raw }}
        };
    </script>
{% endblock %}